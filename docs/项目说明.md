Pinme 项目说明

概要
- 目的：家庭玩具管理（录入、搜索、出入库、提醒、统计）。
- 技术栈：Expo 54、React Native 0.81、React 19、@supabase/supabase-js 2.75、react-native-paper 5.14。
- 部署：Vercel（主）、Netlify（备），后端为 Supabase（Auth、Postgres、Storage、Edge Functions）。

项目位置与结构
- 根目录：E:\Trae
- 前端应用：E:\Trae\pinme
- 关键文件与目录：
  - pinme/App.tsx、index.ts、app.json、package.json
  - pinme/src/supabaseClient.ts（Supabase 客户端初始化）
  - pinme/src/screens/Toys/ToyListScreen.tsx（玩具列表与排序）
  - pinme/src/screens/Toys/ToyFormScreen.tsx、ToyCheckInScreen.tsx（录入、拍照/图库）
  - pinme/src/screens/Stats/StatsScreen.tsx（统计）
  - pinme/src/utils/storage.ts（Storage 桶处理）
  - pinme/docs/灾备快照_latest.md（快速恢复快照）
  - docs/灾备重建指南.md（完整重建指引）
  - supabase/migrations（数据库迁移 SQL）

环境变量
- 文件：pinme/.env（复制自 .env.example）
- 变量：
  - EXPO_PUBLIC_SUPABASE_URL=https://<YOUR_PROJECT_REF>.supabase.co
  - EXPO_PUBLIC_SUPABASE_ANON_KEY=<YOUR_ANON_KEY>

开发与运行
- 安装依赖：npm install
- Web 开发：npm run web（默认使用 Expo Web 开发服务）
- 原生开发：npx expo start；Android：npm run android；iOS：npm run ios
- 隧道二维码（跨网络调试）：npx expo start --tunnel（启动后终端会显示可扫描的二维码与 exp:// 链接）

功能概览
- 账号：邮箱注册/登录、找回密码
- 玩具：录入（名称、RFID、照片、类别、来源、状态、备注）、列表与搜索、状态筛选、一键出库/入库
- 排序：alpha（A–Z）、recent（按 created_at 降序）、popular（近 30 天游玩次数降序，同次数按名称升序）
- 提醒：每日 20:00 自动提醒（Edge Function + pg_cron），本地提醒兜底
- 统计与版本：Stats 页面显示版本与快速检查信息

数据库与安全（Supabase）
- 启用 RLS（按 user_id 隔离数据）
- 表：public.toys、public.device_tokens（均有选择与插入/更新策略）
- 迁移文件位置：
  - supabase/migrations/20251015_pinme.sql
  - supabase/migrations/20251016_add_location_owner.sql
  - supabase/migrations/20251016_create_devices_tables.sql
  - supabase/migrations/20251023_create_play_sessions.sql

Edge Functions 与定时任务
- notify-out-toys：每日提醒；配置在 supabase/functions/notify-out-toys
- figma-sync：将 Figma 设计数据写入 Supabase 表以便 SQL 查询
- Secrets（示例）：SERVICE_ROLE_KEY、FIGMA_TOKEN（通过 supabase secrets 注入）
- 定时任务：pg_cron 每日 20:00；SQL 封装 public.invoke_notify_out_toys 使用 pg_net 调用 HTTP endpoint

构建、部署与上架
- 静态导出（Web）：npx expo export --platform web → dist/
- Vercel：根级 vercel.json 管理重写与构建；生产域名 epplaza.com、www.epplaza.com
- Netlify：pinme/netlify.toml（构建与重写配置）
- EAS（原生包）：eas build -p android/ios；eas submit 提交到商店

跨网络二维码与远程调试
- 使用 “npx expo start --tunnel” 启动隧道模式，终端会显示可扫描的二维码与 exp:// 链接（例如 exp://<hash>.exp.direct）
- 隧道优势：无需在同一局域网下也可调试移动端；适合远程设备或多网络场景
- 注意：偶发受端口占用影响（默认 8081），必要时重试或关闭占用进程

常见问题与处理
- 登录报错 fail to fetch：检查 .env 是否正确，使用 https，Vercel 注入生产环境变量
- 打开页面自动下载文件：检查静态导出、dist 是否存在、vercel.json 是否正确重写
- Edge Function 未触发：确认启用了 pg_cron、部署了函数、SERVICE_ROLE_KEY 已注入；查看 Supabase Logs

灾备与备份
- 快照：pinme/docs/灾备快照_latest.md（最新状态与恢复步骤）
- 完整指引：docs/灾备重建指南.md
- 备份归档：E:\Trae\backups（例如：pinme_backup_YYYYMMDD_HHMMSS.zip 与清单 pinme_backup_manifest_YYYYMMDD_HHMMSS.txt）

版本信息与建议
- 当前版本：app.json 与 package.json 均为 10.18.1
- Expo CLI 提示的对齐建议：升级到 expo-camera ~17.0.8、expo-system-ui ~6.0.8、react-native 0.81.5、react-native-svg 15.12.1、expo-image ~3.0.10（通过 npx expo install 统一对齐）

快速自检清单
- .env 已正确填写 Supabase URL 与 ANON KEY
- npm install 成功，无严重 peer error
- expo start 能启动；玩具列表可加载
- 排序按钮（All、Recently Added、Most Popular）可清除任何分类筛选并正确生效
- Supabase 表存在且无权限错误（RLS）

维护与支持
- 如需生成 PDF 或导出到外部存储，请联系维护者或使用备份脚本：E:\Trae\backups\backup_pinme.ps1
- 如需全量离线备份（包含 node_modules、dist），可提供需求以生成对应脚本与计划任务。