<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Pinme 项目说明</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#222; --bg:#fff; --muted:#666; --accent:#0066cc; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif; }
    .container { max-width: 920px; margin: 24px auto 64px; padding: 0 20px; }
    h1 { font-size: 28px; margin: 0 0 16px; }
    h2 { font-size: 22px; margin: 28px 0 12px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
    h3 { font-size: 18px; margin: 20px 0 8px; }
    p { line-height: 1.7; }
    ul { line-height: 1.7; }
    code, pre { background: #f6f8fa; border: 1px solid #eee; border-radius: 6px; }
    code { padding: 2px 6px; }
    pre { padding: 12px; overflow: auto; }
    .muted { color: var(--muted); }
    .kv { display: grid; grid-template-columns: 180px 1fr; gap: 8px 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .footer { margin-top: 48px; font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
<div class="container">
  <h1>Pinme 项目说明</h1>
  <p class="muted">最后更新：2025-10-24 · 该说明用于快速理解与维护项目，并与灾备文档互补。</p>

  <h2>概要</h2>
  <ul>
    <li>目的：家庭玩具管理（录入、搜索、出入库、提醒、统计）。</li>
    <li>技术栈：Expo 54、React Native 0.81、React 19、@supabase/supabase-js 2.75、react-native-paper 5.14。</li>
    <li>部署：Vercel（主）、Netlify（备）；后端为 Supabase（Auth、Postgres、Storage、Edge Functions）。</li>
  </ul>

  <h2>项目位置与结构</h2>
  <div class="kv">
    <div class="mono">根目录</div><div>E:\Trae</div>
    <div class="mono">前端应用</div><div>E:\Trae\pinme</div>
  </div>
  <ul>
    <li>关键文件：<span class="mono">pinme/App.tsx、index.ts、app.json、package.json</span></li>
    <li>Supabase 客户端：<span class="mono">pinme/src/supabaseClient.ts</span></li>
    <li>主要页面：<span class="mono">ToyListScreen、ToyFormScreen、ToyCheckInScreen、StatsScreen</span></li>
    <li>存储工具：<span class="mono">pinme/src/utils/storage.ts</span></li>
    <li>灾备快照：<span class="mono">pinme/docs/灾备快照_latest.md</span></li>
    <li>完整重建指引：<span class="mono">docs/灾备重建指南.md</span></li>
    <li>数据库迁移：<span class="mono">supabase/migrations</span></li>
  </ul>

  <h2>环境变量</h2>
  <p>文件：<span class="mono">pinme/.env</span>（复制自 <span class="mono">.env.example</span>）</p>
  <pre><code>EXPO_PUBLIC_SUPABASE_URL=https://&lt;YOUR_PROJECT_REF&gt;.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=&lt;YOUR_ANON_KEY&gt;</code></pre>

  <h2>开发与运行</h2>
  <pre><code>npm install
npm run web
# 原生：
npx expo start
npm run android
npm run ios
# 隧道二维码（跨网络调试）：
npx expo start --tunnel</code></pre>

  <h2>功能概览</h2>
  <ul>
    <li>账号：邮箱注册/登录、找回密码。</li>
    <li>玩具：录入（名称、RFID、照片、类别、来源、状态、备注）、列表与搜索、状态筛选、一键出库/入库。</li>
    <li>排序：alpha（A–Z）、recent（按 created_at 降序）、popular（近 30 天游玩次数降序；同次数按名称升序）。</li>
    <li>提醒：每日 20:00 自动提醒（Edge Function + pg_cron），本地提醒兜底。</li>
    <li>统计与版本：Stats 页面显示版本与快速检查信息。</li>
  </ul>

  <h2>数据库与安全（Supabase）</h2>
  <ul>
    <li>RLS：按 <span class="mono">user_id</span> 隔离数据。</li>
    <li>主要表：<span class="mono">public.toys</span>、<span class="mono">public.device_tokens</span>。</li>
    <li>迁移文件：<span class="mono">20251015_pinme.sql、20251016_add_location_owner.sql、20251016_create_devices_tables.sql、20251023_create_play_sessions.sql</span></li>
  </ul>

  <h2>Edge Functions 与定时任务</h2>
  <ul>
    <li><span class="mono">notify-out-toys</span>：每日提醒；位置 <span class="mono">supabase/functions/notify-out-toys</span></li>
    <li><span class="mono">figma-sync</span>：将 Figma 设计数据写入 Supabase 表以便 SQL 查询</li>
    <li>Secrets：<span class="mono">SERVICE_ROLE_KEY</span>、<span class="mono">FIGMA_TOKEN</span>（通过 <span class="mono">supabase secrets</span> 注入）</li>
    <li>定时任务：<span class="mono">pg_cron</span> 每日 20:00；SQL 封装 <span class="mono">public.invoke_notify_out_toys</span> 使用 <span class="mono">pg_net</span> 调用 HTTP。</li>
  </ul>

  <h2>构建、部署与上架</h2>
  <ul>
    <li>静态导出（Web）：<span class="mono">npx expo export --platform web → dist/</span></li>
    <li>Vercel：根级 <span class="mono">vercel.json</span> 管理重写与构建；生产域名 <span class="mono">epplaza.com</span> 与 <span class="mono">www.epplaza.com</span></li>
    <li>Netlify：<span class="mono">pinme/netlify.toml</span>（构建与重写）</li>
    <li>EAS（原生包）：<span class="mono">eas build -p android/ios</span>；<span class="mono">eas submit</span> 提交到商店。</li>
  </ul>

  <h2>常见问题与处理</h2>
  <ul>
    <li>登录报错 <span class="mono">fail to fetch</span>：检查 <span class="mono">.env</span> 是否正确、确保使用 <span class="mono">https</span>、在 Vercel 注入生产环境变量。</li>
    <li>打开页面自动下载文件：检查静态导出与 <span class="mono">dist</span> 是否存在、<span class="mono">vercel.json</span> 重写是否正确。</li>
    <li>Edge Function 未触发：确认启用了 <span class="mono">pg_cron</span>、部署了函数、注入了 <span class="mono">SERVICE_ROLE_KEY</span>；查看 Supabase Logs。</li>
  </ul>

  <h2>灾备与备份</h2>
  <ul>
    <li>快照：<span class="mono">pinme/docs/灾备快照_latest.md</span></li>
    <li>完整指引：<span class="mono">docs/灾备重建指南.md</span></li>
    <li>备份归档：<span class="mono">E:\Trae\backups</span>（<span class="mono">pinme_backup_YYYYMMDD_HHMMSS.zip</span> 与 <span class="mono">pinme_backup_manifest_YYYYMMDD_HHMMSS.txt</span>）。</li>
  </ul>

  <h2>版本与依赖对齐建议</h2>
  <ul>
    <li>当前版本：<span class="mono">app.json</span> 与 <span class="mono">package.json</span> 均为 <span class="mono">10.18.1</span></li>
    <li>Expo CLI 建议对齐：<span class="mono">expo-camera ~17.0.8</span>、<span class="mono">expo-system-ui ~6.0.8</span>、<span class="mono">react-native 0.81.5</span>、<span class="mono">react-native-svg 15.12.1</span>、<span class="mono">expo-image ~3.0.10</span></li>
  </ul>

  <h2>快速自检清单</h2>
  <ul>
    <li>.env 已正确填写 Supabase URL 与 ANON KEY</li>
    <li>npm install 成功，无严重 peer error</li>
    <li>expo start 能启动，玩具列表可加载</li>
    <li>排序按钮（All、Recently Added、Most Popular）可清除任何分类筛选并正确生效</li>
    <li>Supabase 表存在且无权限错误（RLS）</li>
  </ul>

  <div class="footer">维护与支持：备份脚本位于 <span class="mono">E:\Trae\backups\backup_pinme.ps1</span>。如需全量离线备份（包含 node_modules、dist），可联系维护者配置。</div>
</div>
</body>
</html>